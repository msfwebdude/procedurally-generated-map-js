<!DOCTYPE html>
<html>
<head>
	<title></title>
	<meta charset="utf-8" />
</head>
<body>
	<p><br /></p>
	<div style="width: 900px; height: 700px; margin: auto;">
		<canvas id="mapCanvas" width="800" height="600" style="border:1px solid #000099; background-color: black;"></canvas>
	</div>
	<p><br /></p>
	<script type="text/javascript">
		var map = {
			width: 800,
			height: 600
		};

		var maxRtmRatio    = 0.75;
		var maxNumRooms    = 5;

		var numberOfRooms  = Math.floor(Math.random() * maxNumRooms) + 1;
		var maxUsableArea  = Math.floor(map.height * map.width * maxRtmRatio);
		
		console.log('numberOfRooms ' + numberOfRooms);
		console.log('maxUsableArea ' + maxUsableArea);

		var minRoomSize    = 36;
		var maxRoomSize    = Math.floor(Math.min(map.width, map.height) * maxRtmRatio);

		var rooms          = [];

		var canvas         = self.mapCanvas.getContext("2d");
		canvas.strokeStyle = "#009900";
		canvas.fillStyle   = "#556B2F";

		var timesInLoop = 0;

		while(rooms.length <= numberOfRooms && timesInLoop < 100) {
			timesInLoop++;

			var neoRoom = {};

			neoRoom.width      = Math.floor(Math.random() * (maxRoomSize - minRoomSize)) + minRoomSize;
			neoRoom.height     = Math.floor(Math.random() * (maxRoomSize - minRoomSize)) + minRoomSize;
			neoRoom.x1         = Math.floor(Math.random() * (map.width - neoRoom.width - 1));
			neoRoom.y1         = Math.floor(Math.random() * (map.height - neoRoom.height - 1));
			neoRoom.x2         = neoRoom.x1 + neoRoom.width;
			neoRoom.y2         = neoRoom.y1 + neoRoom.height;
			neoRoom.aspect     = Math.floor((Math.min(neoRoom.width, neoRoom.height) / Math.max(neoRoom.width, neoRoom.height)) * 1000) / 1000;
			neoRoom.centerX    = Math.floor((neoRoom.x1 + neoRoom.x2) / 2);
			neoRoom.centerY    = Math.floor((neoRoom.y1 + neoRoom.y2) / 2);
			neoRoom.hypotenuse = Math.floor((Math.sqrt((neoRoom.width * neoRoom.width) + (neoRoom.height * neoRoom.height))) * 1000) / 1000;


			console.log(neoRoom);

			// no intersects
			var doesNotIntersect = true;
			rooms.forEach(
				(room, index) => {
					var adx = Math.abs(neoRoom.centerX - room.centerX);
					var ady = Math.abs(neoRoom.centerY - room.centerY);
					var mdx = (neoRoom.width / 2)  + (room.width / 2)  + 20;
					var mdy = (neoRoom.height / 2) + (room.height / 2) + 20;
					if(adx <= mdx && ady <= mdy){
						doesNotIntersect = false;
					}
				}
			);

			// no too wide or too narrow rooms
			var doesNotMalform = (neoRoom.aspect > 0.2);


			if(doesNotIntersect && doesNotMalform){
				rooms.push(neoRoom);
				canvas.fillRect(neoRoom.x1, neoRoom.y1, neoRoom.width, neoRoom.height);
				canvas.stroke();
				console.log(neoRoom);
			}
		}

		canvas.strokeStyle = "#556B2F";
		canvas.lineWidth = 12;
		rooms.forEach(
			(room, xa) => {
				rooms.forEach(
					(subRoom, xb) => {
						var distance = Math.floor((Math.sqrt( Math.pow(room.centerX - subRoom.centerX, 2) + Math.pow(room.centerY - subRoom.centerY, 2) )) * 1000) / 1000;
						if(distance < room.hypotenuse){
							canvas.moveTo(room.centerX, room.centerY);
							canvas.lineTo(subRoom.centerX, subRoom.centerY);
							canvas.stroke();				
						}
					}
				);				
			}
		);


	</script>
</body>
</html> 